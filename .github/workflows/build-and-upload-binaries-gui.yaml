name: pre-build-and-upload-binaries

on:
  workflow_dispatch:
    inputs:
      tag-name:
        description: The name of the tag to build and upload binaries for
        type: string
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/autowarefoundation/autoware:core-devel
      options: --user root
    steps:
      - name: Get Release Version
        id: get_version
        run: |
          REF_NAME="${{ github.event.inputs.tag-name }}"
          VERSION=${REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Split into major, minor, patch using more compatible method
          MAJOR=$(echo "$VERSION" | cut -d'.' -f1)
          MINOR=$(echo "$VERSION" | cut -d'.' -f2)
          PATCH=$(echo "$VERSION" | cut -d'.' -f3)

          # Default values to 0 if missing
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}

          # Reference version 1.5.2
          REF_MAJOR=1
          REF_MINOR=5
          REF_PATCH=2

          # Compare version parts
          if (( MAJOR < REF_MAJOR )) || \
             (( MAJOR == REF_MAJOR && MINOR < REF_MINOR )) || \
             (( MAJOR == REF_MAJOR && MINOR == REF_MINOR && PATCH <= REF_PATCH )); then
            CATEGORY="before_or_equal_1_5_2"
          else
            CATEGORY="after_1_5_2"
          fi

          echo "Category: $CATEGORY"
          echo "category=$CATEGORY" >> "$GITHUB_OUTPUT"

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: static_build_helper

      - name: Configure Git Safe Directory
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install System Dependencies
        run: |
          set -e
          apt-get update
          apt-get install -y \
            zip
          rm -rf /var/lib/apt/lists/*

      - name: Build validator GUI
        id: build_gui
        shell: bash
        run: |
          set -e

          source /etc/bash.bashrc
          source /opt/ros/humble/setup.bash

          if [ -d "/autoware" ]; then
            echo "Found /autoware directory, sourcing it..."
            cd /autoware
            source install/setup.bash || true
          fi

          for setup_file in $(find /opt -name "setup.bash" | grep -i autoware 2>/dev/null); do
            echo "Sourcing autoware setup: $setup_file"
            source "$setup_file" || true
          done

          cd $GITHUB_WORKSPACE/autoware_lanelet2_map_validator/gui

          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m pip install pyinstaller

          SPEC_FILE=map_validator_gui.spec

          pyinstaller "$SPEC_FILE"

          GUI_BIN=dist/autoware_lanelet2_map_validator_gui
          if [ ! -f "$GUI_BIN" ]; then
            GUI_BIN=$(find dist -maxdepth 2 -type f -executable | head -n 1)
          fi
          ls -l "$GUI_BIN"
          if [ -n "$GUI_BIN" ]; then
            echo "gui_artifact=$(realpath $GUI_BIN)" >> $GITHUB_OUTPUT
          fi
          cd ../..

      - name: Package GUI artifacts
        id: package
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          ZIP_NAME="autoware_lanelet2_map_validator-${VERSION}-linux-x86_64.zip"
          mkdir release_package
          cp "${{ steps.build_gui.outputs.gui_artifact }}" release_package/
          cp -r autoware_lanelet2_map_validator/config release_package/
          cp -r autoware_lanelet2_map_validator/map_requirements release_package/
          strip release_package/$(basename "${{ steps.build_gui.outputs.gui_artifact }}") || true
          zip -r $ZIP_NAME release_package
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Sign the package with GPG
        id: gpg-sign
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --batch --yes --detach-sign --armor --pinentry-mode loopback --passphrase "${{ secrets.GPG_PASSPHRASE }}" -o ${{ steps.package.outputs.zip_name }}.asc ${{ steps.package.outputs.zip_name }}
          echo "signature_name=${{ steps.package.outputs.zip_name }}.asc" >> $GITHUB_OUTPUT

      - name: Install GitHub CLI
        run: |
          (type -p wget >/dev/null || (sudo apt-get update && sudo apt-get install wget -y))
          sudo mkdir -p -m 755 /etc/apt/keyrings
          wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
          sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee  > /dev/null
          sudo apt-get update
          sudo apt-get install gh -y

      - name: Upload artifacts to GitHub Release
        run: |
          gh release upload "${{ steps.get_version.outputs.version }}" \
            "${{ steps.package.outputs.zip_name }}" \
            "${{ steps.gpg-sign.outputs.signature_name }}" \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
